# 計算ロジック仕様書

## 概要
このドキュメントは、介護事業所予実管理SaaSにおける収入・支出の計算ロジックをまとめたものです。
ステータス（確定・見込み・予測）に応じて異なる計算方法を適用します。

## ステータスの種類
- **確定（actual）**: 実際に入力されたデータを使用
- **見込み（forecast）**: 請求データやファクタリング設定から計算、なければ前3ヶ月平均
- **予測（prediction）**: 前3ヶ月の平均値を使用

---

## 収入項目の計算ロジック

### 1. 確定（actual）ステータス
- 入力されているデータをそのまま使用
- データが存在しない場合は0を返す

### 2. 見込み（forecast）ステータス

#### 保険入金（insuranceIncome）
- **計算方法**: 請求データ管理の請求年月が前々月のものの「保険支払額」の合計
- **注意**: ファクタリング設定が有効化されていた場合は0円となる
- **フォールバック**: 前3ヶ月の平均値

#### 【振込】利用者負担（userBurdenTransfer）
- **計算方法**: 請求データ管理の請求年月が当月のもの、かつ、振込にチェックがついている人（`isTransfer = true`）の「利用者負担」（`userBurdenTransfer + userBurdenWithdrawal`）の合計金額を当月に入力
- **フォールバック**: 前3ヶ月の平均値

#### 【口座振替】利用者負担（userBurdenWithdrawal）
- **計算方法**: 請求データ管理の請求年月が前月のもの、かつ、振込にチェックがついていない人（`isTransfer = false`）の「利用者負担」（`userBurdenTransfer + userBurdenWithdrawal`）の合計金額を翌月（当月）に入力
- **理由**: 口座振替は前月の請求が翌月に入金されるため
- **フォールバック**: 前3ヶ月の平均値

#### 【ファクタリング】入金(前月分)（factoringIncome1）
- **計算方法**: ファクタリング設定に基づいて計算
  - 請求年月が当月のものの「保険給付額」の合計を取得
  - 保険給付額 × ファクタリング率 = ファクタリング総額(A)
  - (A) × 手数料率 = 手数料(B)
  - (A) - (B) - 利用料金 = 【ファクタリング】入金(前月分)
  - **計算式**: `Math.max(0, ファクタリング総額 - 手数料 - 利用料)`
- **入力タイミング**: 当月に入力
- **フォールバック**: 前3ヶ月の平均値

#### 【ファクタリング】残金入金(3ヶ月前)（factoringIncome2）
- **計算方法**: ファクタリング設定に基づいて計算
  - 請求年月が当月のものの「保険給付額」の合計を取得
  - 請求年月当月の保険給付額 - ファクタリング総額(A) = 【ファクタリング】残金入金(3ヶ月前)
  - **計算式**: `請求年月当月の保険給付額 - ファクタリング総額(A)`
- **入力タイミング**: 翌月に入力（前月の請求年月の保険給付額から計算）
- **フォールバック**: 前3ヶ月の平均値

#### その他の収入項目
- **代表者借入（representativeLoan）**: 前3ヶ月の平均値
- **短期借入（shortTermLoan）**: 前3ヶ月の平均値
- **長期借入（longTermLoan）**: 
  - **確定**: 入金実績登録の入力データをそのまま使用（データがなければ0）
  - **見込み**: 借入返済管理で入力されている金額
    - 当初借入額（initialBorrowingAmount）を入力する
    - 当初借入日（initialBorrowingDate）が該当している月に入力する
  - **予測**: 借入返済管理で入力されている金額（データがなければ0）
- **受取利息（interestIncome）**: 前3ヶ月の平均値
- **【その他】事業収入（otherBusinessIncome）**: 前3ヶ月の平均値
- **【その他】事業外収入（otherNonBusinessIncome）**: 前3ヶ月の平均値

### 3. 予測（prediction）ステータス
- 長期借入（longTermLoan）のみ借入返済管理から取得、それ以外は前3ヶ月の平均値を計算
- 0を含むすべての値を平均に含める（0の値も有効なデータとして扱う）

---

## 支出項目の計算ロジック

### 1. 確定（actual）ステータス
- 入力されているデータをそのまま使用
- データが存在しない場合は0を返す

### 2. 見込み（forecast）ステータス
- 借入返済管理から取得できる項目はそれを使用、なければ前3ヶ月平均
- **借入返済管理から取得する項目**:
  - 支払利息（paymentInterest）
  - 長期借入金返済（longTermLoanRepayment）
- **前3ヶ月の平均値を入力する項目**:
  - 代表者借入金返済（representativeLoanRepayment）
  - 短期借入金返済（shortTermLoanRepayment）
- **その他の項目**: 前3ヶ月の平均値

### 3. 予測（prediction）ステータス
- 長期借入金返済のみ借入返済管理から取得、それ以外は前3ヶ月の平均値
- 0を含むすべての値を平均に含める

---

## 補助関数

### getPrevious3Months(yearMonth: string): string[]
対象年月から前3ヶ月の年月リストを生成します。

**例**: `2025-01` → `['2024-10', '2024-11', '2024-12']`

### calculateAverage3Months(records: Array<Record<string, any>>, field: string): number
前3ヶ月のレコードから指定フィールドの平均値を計算します。

**計算方法**:
1. レコードが存在しない場合は0を返す
2. 指定フィールドの値を数値に変換
3. NaNでない値をすべて含める（0の値も有効なデータとして扱う）
4. 平均値を計算して四捨五入

---

## ファクタリング計算ロジック詳細

### ファクタリング設定項目
- **factoringRate**: ファクタリング率（例: 8000 = 80.00%）
- **remainingRate**: 残金率（例: 2000 = 20.00%）
- **feeRate**: 手数料率（例: 70 = 0.700%）
- **usageFee**: 利用料（例: 2000 = ¥2,000）

### 【ファクタリング】入金(前月分)（factoringIncome1）の計算

**対象データ**: 請求年月が当月のものの「保険給付額（insurancePayment）」の合計

**計算ステップ**:
1. 当月の保険給付額を取得: `currentInsurancePayment`
2. ファクタリング率を適用: `factoringAmount = currentInsurancePayment × (factoringRate / 10000)`
   - 例: 100万円 × (8000 / 10000) = 80万円
3. 手数料を計算: `fee = factoringAmount × (feeRate / 10000)`
   - 例: 80万円 × (70 / 10000) = 5,600円
4. 利用料を差し引く: `factoringIncome1 = Math.max(0, factoringAmount - fee - usageFee)`
   - 例: `Math.max(0, 800,000 - 5,600 - 2,000) = 792,400円`

**入力タイミング**: 当月に入力

**注意**: ファクタリング設定が存在しない、または当月の保険給付額が0の場合は0を返す

### 【ファクタリング】残金入金(3ヶ月前)（factoringIncome2）の計算

**対象データ**: 請求年月が前月のものの「保険給付額（insurancePayment）」の合計

**計算ステップ**:
1. 前月の保険給付額を取得: `prevInsurancePayment`
2. 前月の保険給付額からファクタリング総額(A)を計算: `factoringAmount = prevInsurancePayment × (factoringRate / 10000)`
   - 例: 100万円 × (8000 / 10000) = 80万円
3. 残金を計算: `factoringIncome2 = prevInsurancePayment - factoringAmount`
   - 例: 100万円 - 80万円 = 20万円

**入力タイミング**: 翌月に入力（前月の請求年月の保険給付額から計算）

**注意**: ファクタリング設定が存在しない、または前月の保険給付額が0の場合は0を返す

---

## 支払利息（paymentInterest）の計算ロジック

### 計算方法

借入返済管理で登録されている有効な借入について、対象年月の支払利息を計算します。

**計算ステップ**:

1. **有効な借入を取得**
   - 対象年月の月末日時点で有効な借入（`isActive = true` かつ `effectiveFrom <= 対象年月の月末日`）を取得
   - 対象年月が初回返済日の年月より前の場合はスキップ

2. **対象年月時点での借入残高を計算**
   - 初回返済日から対象年月の前月まで、逐次返済を計算して残高を求める
   - 初期残高は`initialBorrowingAmount`（当初借入額）から開始

3. **対象年月の返済額を計算**
   - **月利の計算**: `月利 = 年利（annualInterestRate） / 12 / 100`
   - **返済方法に応じた計算**:
     - **元金均等返済（equal_principal）**:
       - 返済元金: `repaymentPrincipal`（固定）
       - 支払利息: `Math.round(借入残高 × 月利)`
     - **元利均等返済（equal_installment）**:
       - 月々の返済額: 借入額と月利から計算した固定額
       - 支払利息: `Math.round(借入残高 × 月利)`
       - 返済元金: `返済額 - 支払利息`

4. **支払利息の合計**
   - すべての有効な借入の支払利息を合計

**計算例**:
- 借入額: 1,000万円
- 年利: 1.5%（0.015）
- 月利: 0.015 / 12 = 0.00125（0.125%）
- 対象年月時点の残高: 800万円
- 支払利息: `8,000,000 × 0.00125 = 10,000円`

**注意事項**:
- 借入の種類（代表者借入・短期借入・長期借入）に関係なく、すべての借入の支払利息を合計
- 現在の実装では、すべての借入を長期借入として扱っている（暫定実装）

---

## データ取得のタイミング

### 請求データの取得タイミング
- **当月**: 請求年月が当月の請求データ（ファクタリング入金1用）
- **前月**: 請求年月が前月の請求データ（ファクタリング残金入金用、口座振替利用者負担用）
- **前々月**: 請求年月が前々月の請求データ（保険入金用、ただしファクタリング設定が有効な場合は0）

### 年月の計算方法
- 対象年月: `YYYY-MM`形式（例: `2025-01`）
- 請求年月: `YYYYMM`形式（例: `202501`）
- 月の計算は0ベースではなく1ベースで扱う（1月=1, 12月=12）

---

## エラーハンドリング

### isTransferカラムが存在しない場合
- 旧データとの互換性のため、従来のロジックを使用
- 当月の`userBurdenTransfer`と`userBurdenWithdrawal`をそのまま使用

### データベース接続エラー
- データベースに接続できない場合は、すべて0を返す

### データが存在しない場合
- 各ステータスでデータが存在しない場合は、フォールバックロジックを使用
- フォールバックも存在しない場合は0を返す

---

## 実装ファイル
- `server/statusCalculator.ts`: メインの計算ロジック
- `server/db.ts`: データベースアクセス関数
- `server/loanCalculator.ts`: 借入返済計算ロジック

